<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>고군분투 - Flash Launcher</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Ruffle: Flash 에뮬레이터 (CDN) -->
  <script src="https://unpkg.com/@ruffle-rs/ruffle"></script>
  <link rel="stylesheet" href="styles.css" />

  <!-- favicon 설정 (16x16 PNG) -->
  <link rel="icon" href="favicon.png" type="image/png" sizes="16x16" />

  <meta name="color-scheme" content="dark light">
</head>
<body>
  <header class="site-header">
    <h1>고군분투</h1>
    <p class="subtitle">Flash 에뮬레이터(Ruffle)로 브라우저에서 바로 플레이</p>
  </header>

  <main class="container">
    <section class="player-card">
      <div class="player-toolbar">
        <button id="btnReload" class="btn" title="다시 로드">🔄 다시 로드</button>
        <button id="btnFullscreen" class="btn" title="전체화면 전환">⛶ 전체화면</button>
        <label class="file-label">
          💾 SWF 파일 열기
          <input id="fileInput" type="file" accept=".swf" />
        </label>
      </div>

      <div id="stage" class="stage" aria-label="게임 무대"></div>

      <p class="hint">
        기본으로 <code>assets/고군분투.swf</code>를 로드합니다.<br/>
        다른 SWF를 시험해보고 싶으면 위의 <b>SWF 파일 열기</b> 버튼을 사용하거나 무대에 <b>드래그&드롭</b>하세요.
      </p>
    </section>

    <section class="faq">
      <details>
        <summary>실행 안 될 때 체크리스트</summary>
        <ul>
          <li><b>파일 경로</b>: <code>assets/고군분투.swf</code> 가 실제로 존재하는지 확인</li>
          <li><b>정적 서버</b>: 일부 브라우저는 <code>file://</code> 로드 시 WASM/SWF 접근을 제한합니다.<br/>
            가능한 경우 간단한 정적 서버(예: VSCode Live Server, <code>python -m http.server</code>)로 열어주세요.</li>
          <li><b>새로고침</b>: 캐시 문제일 수 있어 Ctrl+F5(강력 새로고침) 시도</li>
        </ul>
      </details>
    </section>
  </main>

  <footer class="site-footer">
    <small>© 2025 Flash Game Launcher · Ruffle 기반</small>
  </footer>

  <script>
    const stage = document.getElementById('stage');
    const fileInput = document.getElementById('fileInput');
    const btnReload = document.getElementById('btnReload');
    const btnFullscreen = document.getElementById('btnFullscreen');

    let rufflePlayer;
    // 기본 로드 경로를 고군분투로 변경
    let currentSrc = "assets/고군분투.swf";

    function createPlayer() {
      stage.innerHTML = "";
      const ruffle = window.RufflePlayer?.newest();
      rufflePlayer = ruffle.createPlayer();
      rufflePlayer.classList.add("ruffle-player");
      stage.appendChild(rufflePlayer);
      rufflePlayer.style.width = "100%";
      rufflePlayer.style.height = "100%";
      rufflePlayer.load(currentSrc).catch(err => {
        console.error("SWF 로드 실패:", err);
        stage.innerHTML = `
          <div class="error">
            <p>SWF 로드에 실패했습니다.</p>
            <p class="mono">${escapeHtml(String(err))}</p>
            <p>경로와 서버 구동 여부를 확인해주세요.</p>
          </div>`;
      });
    }

    function escapeHtml(s) {
      return s.replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("'", "&#039;");
    }

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      currentSrc = url;
      createPlayer();
    });

    stage.addEventListener('dragover', (e) => {
      e.preventDefault();
      stage.classList.add('dragover');
    });
    stage.addEventListener('dragleave', () => stage.classList.remove('dragover'));
    stage.addEventListener('drop', (e) => {
      e.preventDefault();
      stage.classList.remove('dragover');
      const file = e.dataTransfer?.files?.[0];
      if (file && file.name.toLowerCase().endsWith('.swf')) {
        const url = URL.createObjectURL(file);
        currentSrc = url;
        createPlayer();
      }
    });

    btnReload.addEventListener('click', () => createPlayer());
    btnFullscreen.addEventListener('click', () => {
      if (!rufflePlayer) return;
      if (rufflePlayer.requestFullscreen) {
        rufflePlayer.requestFullscreen();
      } else if (stage.requestFullscreen) {
        stage.requestFullscreen();
      }
    });

    document.addEventListener('DOMContentLoaded', createPlayer);
  </script>
</body>
</html>
